# Dockerfile otimizado para EasyPanel - Facebook Reports System
FROM python:3.11-slim

LABEL maintainer="Facebook Reports System"
LABEL version="3.0.1"
LABEL description="Sistema de Relat√≥rios Facebook/Google Ads - Produ√ß√£o"

# Vari√°veis de ambiente para otimiza√ß√£o
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV DEBIAN_FRONTEND=noninteractive

# Instalar depend√™ncias do sistema e gosu
RUN apt-get update && apt-get install -y \
    gcc g++ \
    curl \
    cron \
    procps \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Instalar gosu para mudan√ßa segura de usu√°rio
RUN set -eux; \
    dpkgArch="$(dpkg --print-architecture | awk -F- '{ print $NF }')"; \
    curl -o /usr/local/bin/gosu -SL "https://github.com/tianon/gosu/releases/download/1.17/gosu-$dpkgArch"; \
    chmod +x /usr/local/bin/gosu; \
    gosu --version; \
    gosu nobody true

# Criar usu√°rio n√£o-root para seguran√ßa
RUN groupadd -r appuser && useradd -r -g appuser -m -d /app appuser

# Configurar diret√≥rio de trabalho
WORKDIR /app

# Instalar depend√™ncias Python
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Copiar c√≥digo da aplica√ß√£o
COPY . .

# Criar estruturas necess√°rias
RUN mkdir -p /app/logs /app/backup /app/static /app/templates && \
    chown -R appuser:appuser /app

# Script de inicializa√ß√£o otimizado
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "üöÄ Facebook Reports System - Starting..."\n\
echo "========================================"\n\
\n\
# Verificar vari√°veis cr√≠ticas\n\
required_vars="SUPABASE_URL SUPABASE_KEY FACEBOOK_ACCESS_TOKEN"\n\
for var in $required_vars; do\n\
    if [ -z "${!var}" ]; then\n\
        echo "‚ùå ERROR: Required environment variable $var is not set"\n\
        exit 1\n\
    fi\n\
done\n\
\n\
# Configurar logs\n\
mkdir -p /app/logs\n\
chown -R appuser:appuser /app/logs\n\
\n\
# Configurar cron se habilitado\n\
if [ "${ENABLE_CRON:-false}" = "true" ]; then\n\
    echo "üìÖ Setting up cron for daily updates..."\n\
    echo "0 ${DAILY_UPDATE_HOUR:-6} * * * cd /app && python daily_auto_update.py >> /app/logs/daily_update.log 2>&1" | crontab -u appuser -\n\
    service cron start\n\
    echo "‚úÖ Cron enabled for daily updates"\n\
fi\n\
\n\
echo "üéØ Starting application on port ${WEB_PORT:-5000}"\n\
echo "‚úÖ User: appuser"\n\
echo "‚úÖ Python: $(python --version)"\n\
echo "‚úÖ Working directory: $(pwd)"\n\
echo "========================================"\n\
\n\
# Executar como usu√°rio n√£o-root usando gosu\n\
exec gosu appuser "$@"\n\
' > /docker-entrypoint.sh && chmod +x /docker-entrypoint.sh

# Healthcheck simples sem curl (que pode n√£o estar dispon√≠vel)
RUN echo '#!/bin/bash\n\
if pgrep -f "python.*app.py" > /dev/null; then\n\
    exit 0\n\
else\n\
    exit 1\n\
fi\n\
' > /healthcheck.sh && chmod +x /healthcheck.sh

# Healthcheck usando verifica√ß√£o de processo
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD /healthcheck.sh

# Configura√ß√µes finais
EXPOSE 5000

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["python", "app.py"]
